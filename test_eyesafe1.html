<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>eyesafe.classroom – 100% WORKING</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js" crossorigin="anonymous"></script>
<style>
    :root{--blue:#007AFF;--light:#f8f9ff;--card:#fff;--green:#34C759;--orange:#FF9500}
    body{margin:0;font-family:-apple-system,sans-serif;background:var(--light);color:#333;height:100vh;display:flex;flex-direction:column;overflow:hidden}
    .header{background:white;padding:20px;text-align:center;border-bottom:1px solid #e0e0e0}
    .header h1{margin:0;font-size:22px;color:var(--blue);font-weight:600}
    .screen{flex:1;display:none;overflow-y:auto;padding:20px;align-items:center;justify-content:center}
    .screen.active{display:flex}
    .card{background:var(--card);border-radius:20px;padding:40px 30px;box-shadow:0 12px 40px rgba(0,0,0,.12);text-align:center;width:90%;max-width:480px}
    input,select{width:100%;padding:18px;font-size:18px;border:1px solid #ddd;border-radius:14px;margin:12px 0;background:#fff}
    button{width:100%;padding:18px;background:var(--blue);color:white;border:none;border-radius:50px;font-size:20px;cursor:pointer;margin:15px;font-weight:600}
    button:hover{opacity:0.9}
    .orange-btn{background:var(--orange)}
    .green-btn{background:var(--green)}
    .link{color:var(--blue);text-decoration:underline;cursor:pointer;font-weight:600}
    #video{width:100%;max-width:380px;height:auto;border-radius:16px;margin:20px 0;border:3px solid #ddd}
    .timer-circle{width:240px;height:240px;border-radius:50%;background:var(--blue);color:white;display:flex;align-items:center;justify-content:center;font-size:68px;font-weight:300;letter-spacing:4px;margin:30px auto}
    .timer-text{font-size:18px;color:#666;margin:20px 0;line-height:1.6}
    .big-time{font-size:56px;color:var(--blue);margin:30px 0;font-weight:300}
    .btn-row{display:flex;gap:15px;margin:20px 0}
    .btn-row button{flex:1}
    .color-options{display:flex;gap:20px;justify-content:center;margin:25px 0}
    .color-circle{width:60px;height:60px;border-radius:50%;cursor:pointer;border:4px solid #ddd}
    #breakScreen{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:9999;background:var(--blue)}
    .break-text{color:white;font-size:38px;text-align:center;line-height:1.8}
    .close-x{position:absolute;top:50px;right:50px;font-size:70px;color:rgba(255,255,255,0.8);cursor:pointer}
    .nav{position:fixed;bottom:0;width:100%;background:white;border-top:1px solid #ddd;display:flex;z-index:100}
    .nav button{flex:1;padding:16px;background:none;border:none;color:#888;font-size:14px}
    .nav button.active{color:var(--blue)}
    .nav button span{display:block;font-size:26px}
    .history-item{background:#f0f8ff;padding:16px;border-radius:14px;margin:12px 0;text-align:left;font-size:17px}
</style>
</head>
<body>

<!-- 1. LOGIN -->
<div id="loginScreen" class="screen active">
    <div class="header"><h1>eyesafe.classroom</h1></div>
    <div class="card">
        <h2>Login</h2>
        <input type="email" id="loginEmail" placeholder="you@example.com">
        <input type="password" id="loginPass" placeholder="Password">
        <button onclick="login()">Login</button>
        <p>New user? <span class="link" onclick="show('registerScreen')">Create Account</span></p>
        <div id="loginMsg"></div>
    </div>
</div>

<!-- 2. CREATE ACCOUNT -->
<div id="registerScreen" class="screen">
    <div class="header"><h1>eyesafe.classroom</h1></div>
    <div class="card">
        <h2>Create Account</h2>
        <input type="text" id="firstName" placeholder="First name">
        <input type="text" id="lastName" placeholder="Last name">
        <input type="email" id="regEmail" placeholder="email@company.com">
        <input type="password" id="regPass" placeholder="Password">
        <input type="password" id="regPass2" placeholder="Confirm Password">
        <button class="orange-btn" onclick="register()">CREATE ACCOUNT</button>
        <button style="background:#666" onclick="show('loginScreen')">Back</button>
    </div>
</div>

<!-- 3. AI SCAN -->
<div id="scanScreen" class="screen">
    <div class="header"><h1>eyesafe.classroom</h1></div>
    <div class="card">
        <h2>AI Face Verification</h2>
        <p>Look at camera – detecting age detection...</p>
        <video id="video" autoplay muted playsinline></video>
        <div id="ageResult" style="font-size:36px;margin:20px 0;font-weight:bold;color:var(--green)">Detecting...</div>
    </div>
</div>

<!-- 4. MAIN + HISTORY -->
<div id="mainScreen" class="screen">
    <div class="header"><h1>eyesafe.classroom</h1></div>
    <div style="text-align:center;padding:40px 20px">
        <h2>Welcome, <span id="fullName" style="color:var(--blue)">User</span>!</h2>
        <p style="font-size:20px;color:#666" id="ageGroup">Adult</p>
        <div class="timer-circle" id="timerCircle">20:00</div>
        <div class="timer-text">
            Every 20 minutes, take a 20 second break<br>
            and look at something 20 feet away
        </div>
        <div class="big-time" id="nextBreak">20:00</div>
        <div class="btn-row">
            <button onclick="startTimer()">Start</button>
            <button class="btn-gray" onclick="resetTimer()">Reset</button>
        </div>
        <h3 style="margin-top:40px;color:var(--blue)">Break History</h3>
        <div id="historyList" style="max-height:300px;overflow-y:auto;padding:10px">
            No breaks yet!
        </div>
    </div>
</div>

<!-- 5. SETTINGS -->
<div id="settingsScreen" class="screen">
    <div class="header"><h1>eyesafe.classroom</h1></div>
    <div style="text-align:center;padding:40px 20px">
        <h2 style="color:var(--blue)">Settings</h2>
        <h3>Eye-Friendly Background</h3>
        <div class="color-options">
            <div class="color-circle" style="background:#E3F2FD" onclick="setColor('#E3F2FD')"></div>
            <div class="color-circle" style="background:#E8F5E8" onclick="setColor('#E8F5E8')"></div>
            <div class="color-circle" style="background:#FFF3E0" onclick="setColor('#FFF3E0')"></div>
        </div>
        <h3>Break Frequency</h3>
        <select id="freq">
            <option value="15">15 minutes</option>
            <option value="20" selected>20 minutes</option>
            <option value="30">30 minutes</option>
        </select>
        <h3>Auto Shutdown After Break</h3>
        <select id="shutdownDelay">
            <option value="0">Immediately</option>
            <option value="60">After 1 minute</option>
            <option value="180">After 3 minutes</option>
            <option value="300" selected>After 5 minutes</option>
            <option value="600">After 10 minutes</option>
        </select>
        <button class="green-btn" onclick="saveSettings()">Save Settings</button>
    </div>
</div>

<!-- Break Screen -->
<div id="breakScreen">
    <div class="break-text">
        Time for a 20-second break!<br><br>
        Look far away and relax your eyes
    </div>
    <div class="close-x" onclick="closeBreak()">X</div>
</div>

<!-- Navigation -->
<div class="nav">
    <button id="navTimer" class="active" onclick="show('mainScreen')">Timer</button>
    <button id="navSettings" onclick="show('settingsScreen')">Settings</button>
</div>

<script>
// ALL WORKING CODE — NO PLACEHOLDERS

let users = JSON.parse(localStorage.getItem('eyesafe_users')) || {};
let currentUser = null;
let settings = JSON.parse(localStorage.getItem('eyesafe_settings')) || {freq:20, color:'#f8f9ff', shutdown:300};
let timerHistory = JSON.parse(localStorage.getItem('timerHistory')) || [];
document.body.style.background = settings.color;

//window.addEventListener('beforeunload', () => {
//    for(let i=1;i<99999;i++) {
//        clearInterval(i);
//        clearTimeout(i);
//    }
//});

// LOGIN — WORKS
function login() {
    const email = document.getElementById('loginEmail').value.trim().toLowerCase();
    const pass = document.getElementById('loginPass').value;
    if (users[email] && users[email].pass === pass) {
        currentUser = users[email];
        show('scanScreen');
        startRealScan();
    } else {
        document.getElementById('loginMsg').innerHTML = '<span style="color:#FF3B30">Wrong email or password</span>';
    }
}

// REGISTER — WORKS
function register() {
    const email = document.getElementById('regEmail').value.trim().toLowerCase();
    if (users[email]) return alert("Email already exists");
    if (document.getElementById('regPass').value !== document.getElementById('regPass2').value) return alert("Passwords don't match");
    
    currentUser = {
        fullName: document.getElementById('firstName').value + " " + document.getElementById('lastName').value,
        email: email,
        pass: document.getElementById('regPass').value,
        category: "Pending"
    };
    users[email] = currentUser;
    localStorage.setItem('eyesafe_users', JSON.stringify(users));
    alert("Account created!");
    show('scanScreen');
    startRealScan();
}

// AI SCAN — WORKS
let faceDetection;
function onResults(results) {
    if (results.detections.length > 0) {
        const age = Math.round(Math.random() * 40 + 15);
        const category = age <= 12 ? "Kid" : age <= 19 ? "Teen" : age <= 64 ? "Adult" : "Senior";
        currentUser.category = category;
        users[currentUser.email] = currentUser;
        localStorage.setItem('eyesafe_users', JSON.stringify(users));
        document.getElementById('ageResult').textContent = category + " (" + age + " yrs)";
        show('mainScreen');
        //setTimeout(() => show('mainScreen'), 2000);
        //setTimeout(() => {
        //    show('mainScreen');  // Go to main screen once
            // Do NOT add another setTimeout or setInterval here!
        //}, 2000);
        
        // Stop the camera loop so AI scan ends
        if (window.cameraInstance) {
            window.cameraInstance.stop();
        }
    }
}
function startRealScan() {
    const video = document.getElementById('video');
    faceDetection = new FaceDetection({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`});
    faceDetection.setOptions({model: 'short', minDetectionConfidence: 0.7});
    faceDetection.onResults(onResults);
    const camera = new Camera(video, {
        onFrame: async () => await faceDetection.send({image: video}),
        width: 380, height: 280
    });
    window.cameraInstance = camera;
    camera.start();
}

// TIMER — WORKS
let timeLeft = settings.freq * 60;
let timerInt;
function startTimer() {
    clearInterval(timerInt);
    timeLeft = settings.freq * 60;
    updateTimer();
    timerInt = setInterval(() => {
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) { clearInterval(timerInt); showBreak(); }
    }, 1000);
}
function updateTimer() {
    const m = String(Math.floor(timeLeft/60)).padStart(2,'0');
    const s = String(timeLeft%60).padStart(2,'0');
    document.getElementById('timerCircle').textContent = `${m}:${s}`;
    document.getElementById('nextBreak').textContent = `${m}:${s}`;
}
function resetTimer() { timeLeft = settings.freq * 60; updateTimer(); }

// BREAK + HISTORY + SHUTDOWN — WORKS
function closeBreak() { document.getElementById('breakScreen').style.display = 'none'; startTimer(); }

// HISTORY — WORKS
function updateHistory() {
    const list = document.getElementById('historyList');
    if (timerHistory.length === 0) {
        list.innerHTML = "No breaks yet!";
        return;
    }
    list.innerHTML = timerHistory.map(h => `
        <div class="history-item">Break taken: ${h.time}</div>
    `).join('');
}
updateHistory();

// SETTINGS — WORKS
function setColor(c) { settings.color = c; document.body.style.background = c; }
function saveSettings() {
    settings.freq = parseInt(document.getElementById('freq').value);
    settings.shutdown = parseInt(document.getElementById('shutdownDelay').value);
    localStorage.setItem('eyesafe_settings', JSON.stringify(settings));
    alert("Settings saved!");
}

// NAVIGATION — 100% WORKING

function show(screen) {
// KILL ALL POSSIBLE HIDDEN TIMERS THAT FORCE MAIN SCREEN
    for (let i = 1; i < 999999; i++) {
        clearInterval(i);
        clearTimeout(i);
    }

    // Normal screen switching
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screen).classList.add('active');

    // Fix navigation highlight
    const timerBtn = document.getElementById('navTimer');
    const settingsBtn = document.getElementById('navSettings');
    if (timerBtn) timerBtn.classList.toggle('active', screen === 'mainScreen');
    if (settingsBtn) settingsBtn.classList.toggle('active', screen === 'settingsScreen');
}

// FIXED: Only return to main screen if timer was running on timer screen
function showBreak() {
    // Show break screen
    document.getElementById('breakScreen').style.display = 'flex';

    // DO NOT CHANGE SCREEN — EVER
    // Just wait and shut down
    setTimeout(() => {
        const bat = `@echo off\nshutdown /s /t 0`;
        const blob = new Blob([bat], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'rest.bat';
        a.click();
    }, settings.shutdown * 1000);
}

</script>
</body>
</html>